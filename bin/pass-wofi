#!/usr/bin/env bash
set -euo pipefail

cd "${PASSWORD_STORE_DIR:-$HOME/.password-store}" || exit 1

class=""
if [ "$XDG_CURRENT_DESKTOP" == "Hyprland" ]; then
  class="$(hyprctl activewindow -j | jq -r '.class')"
elif [ "$XDG_CURRENT_DESKTOP" == "sway" ]; then
  focused="$(swaymsg -t get_tree | jq -r '.. | (.nodes? // empty)[] | select(.focused==true)')"
  class=$(jq -r '.window_properties.class' <<<"$focused")
fi

query=""
if [[ $class == "org.qutebrowser.qutebrowser" ]]; then
  qutebrowser :yank
  query=$(wl-paste | cut -d '/' -f3 | sed s/"www."//)
elif [[ $class == "discord" ]]; then
  query="discord.com"
elif [[ $class == "Steam" ]]; then
  query="steampowered.com"
fi

selected=$(find -L . -not -path '*\/.*' -path "*.gpg" -type f -printf '%P\n' |
  sed 's/.gpg$//g' |
  walker --dmenu --query "$query") || exit 2

#username=$(echo "$selected" | cut -d '/' -f2)
#url=$(echo "$selected" | cut -d '/' -f1)

#pass "$selected" | grep 'login:' | cut -d ' ' -f2

fields="Password
Username
OTP
URL"

field=$(printf '%s' "$fields" | walker --dmenu) || field="Password"

case "$field" in
"Password")
  value="$(pass "$selected" | head -n 1)"
  if [ -z "$value" ]; then
    notify-send "Error" "No password for $selected" -i error -t 6000
    exit 3
  fi
  ;;
"Username")
  value="$(pass "$selected" | grep 'login:' | cut -d ' ' -f2)"
  if [ -z "$value" ]; then
    notify-send "Error" "No username for $selected" -i error -t 6000
    exit 3
  fi
  ;;
"URL")
  value="$(pass "$selected" | grep 'url:' | cut -d ' ' -f2)"
  if [ -z "$value" ]; then
    notify-send "Error" "No URL for $selected" -i error -t 6000
    exit 3
  fi
  ;;
"OTP")
  if ! value=$(pass otp "$selected"); then
    notify-send "Error" "No OTP for $selected" -i error -t 6000
    exit 3
  fi
  ;;
*)
  exit 4
  ;;
esac

wl-copy "$value"
#notify-send "Copied $field:" "$value" -i edit-copy -t 4000
notify-send "Copied $field:" "hidden" -i edit-copy -t 4000
